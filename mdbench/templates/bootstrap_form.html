{% extends "base_generic.html" %}

{%block content%}
<div class="card border-0 text-left pt-4" style="background-image: url('https://mdbench.ace-net.ca/static/media/images/background.png'); border-radius: 0;">
    <div class="card-title"><h3>ADVANCED SEARCH</h3></div>
    <div class="card-body">
    <form method='GET' action = '.'>
        <div class="row">
            <div class="col-sm-3">
                <div class="form-group">
                    <div class="input-group">
                        <div class="input">
                            <label for="software_contains" class="form-label">Software name</label>
                            <select class="form-select mb-1 form-select-sm"  type="search" name = "software_contains"/>
                            <option value="">All</option>
                            <option value="GROMACS">GROMACS</option>                   
                            <option value="GROMACS.cuda">GROMACS.cuda</option>  
                            <option value="GROMACS.cuda.mpi">GROMACS.cuda.mpi</option>  
                            <option value="GROMACS.mpi">GROMACS.mpi</option>    
                            <option value="NAMD2">NAMD2</option>                    
                            <option value="NAMD2.cuda">NAMD2.cuda</option>  
                            <option value="NAMD2.cuda.ofi">NAMD2.cuda.ofi</option>                                
                            <option value="NAMD2.omp">NAMD2.omp</option>
                            <option value="NAMD2.ucx">NAMD2.ucx</option>
                            <option value="NAMD3">NAMD3</option>
                            <option value="NAMD3.cuda">NAMD3.cuda</option>
                            <option value="OPENMM.cuda">OPENMM.cuda</option>                       
                            <option value="PMEMD">PMEMD</option>
                            <option value="PMEMD.cuda">PMEMD.cuda</option>
                            <option value="PMEMD.mpi">PMEMD.mpi</option>
                            <option value="PMEMD.cuda.MPI">PMEMD.cuda.mpi</option>
                            <option value="SANDER.QUICK.cuda">SANDER.QUICK.cuda</option>      
                            <option value="SANDER.QUICK.cuda.MPI">SANDER.QUICK.cuda.MPI</option>                                                     
                            </select> 
                        </div>            
                    </div>
                </div>
            </div>

            <div class="col-sm-2">
               <div class="form-group">
                  <div class="input-group">
                     <div class="input">
                        <label for="arch" class="form-label">Software ID</label>
                        <input class="mb-1 form-control form-control-sm" spellcheck="false" type="number" min="1" name = "software_id" placeholder="Enter ID .."/>    
                        </select>                     
                     </div>            
                  </div>
               </div>
            </div>          

            <div class="col-sm-2">
                <div class="form-group">
                    <div class="input-group">
                        <div class="input" >
                            <label for="module_contains" class="form-label">Module</label>
                            <select class="form-select mb-1 form-select-sm" style="background-color: #b7b796;"  name = "module_contains"/>
                            <option value="">All</option>
                            <option value="amber">amber</option>     
                            <option value="ambertools">ambertools</option>                                                      
                            <option value="gromacs">gromacs</option>                   
                            <option value="namd">namd</option>  
                            <option value="namd-multicore">namd-multicore</option>    
                            <option value="namd-ofi-smp">namd-ofi-smp</option>                            
                            <option value="namd-ucx">namd-ucx</option>                    
                            <option value="binary_pack">precompiled package</option>
                            </select>                        
                        </div>            
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="form-group">
                    <div class="input-group">
                        <div class="input" >
                              <label for="module_version" class="form-label">Module version</label>
                              <input class="mb-1 form-control form-control-sm w-50" spellcheck="false" style="background-color: #b7b796;"  type="search" name = "module_version" placeholder="Enter version .."/>
                        </div>            
                    </div>
                </div>
            </div>

            <div class="col-sm-2">
               <div class="form-group">
                  <div class="input-group">
                    <div class="input">
                      <label for="site_comtains" class="form-label">Cluster</label>
                      <select class="form-select mb-1 form-select-sm" type="search" name = "site_contains" placeholder="Narval .."/>
                          <option value="">All</option>
                          <option value="Argo">Argo</option>			  
                          <option value="Beluga">Beluga</option>                   
                          <option value="Cedar">Cedar</option>  
                          <option value="Graham">Graham</option>    
                          <option value="Narval">Narval</option>                    
                          <option value="Niagara">Niagara</option>
                          <option value="Nibi">Nibi</option>          
                          <option value="Rorqual">Rorqual</option>      
                          <option value="Siku">Siku</option>
                      </select>
                    </div>            
                  </div>
               </div>
            </div>

            <div class="row py-4">
                <div class="col-sm-3">
                    <div class="form-group">
                        <div class="input-group">
                            <div class="input">
                                <label for="gpu" class="form-label">GPU model</label>
                                <select class="form-select mb-1 form-select-sm" style="background-color: #b7b796;" name = "gpu_model"/>
                                <option value="">All</option>
                                <option value="H100-SXM5">H100-SXM5</option>                                
                                <option value="H100-NVL">H100-NVL</option>
                                <option value="A100-SXM4">A100-SXM4</option>
                                <option value="P100-PCIE">P100-PCIE</option>    
                                <option value="RTX6000">RTX6000</option>       
                                <option value="T4">T4</option>                                             
                                <option value="V100">V100</option>                              
                                <option value="V100-PCIE">V100-PCIE</option>   
                                <option value="V100-SXM2">V100-SXM2</option>   
                                </select>       
                            </div>            
                        </div>
                    </div>
                </div>    

            <div class="col-sm-2">
                <div class="form-group">
                    <div class="input-group">
                        <div class="input">
                          <label for="cpu" class="form-label">CPU model</label>
                          <select class="form-select mb-1 form-select-sm" style="background-color: #b7b796;" name = "cpu_model"/>
                          <option value="">All</option>
                          <option value="9654">EPYC 9654</option>
                          <option value="7532">EPYC 7532</option>
                          <option value="7413">EPYC 7413</option>    
                          <option value="8570">XEON PLATINUM 8570</option>   
                          <option value="8160">XEON PLATINUM 8160</option>   
                          <option value="5418Y">XEON GOLD 5418Y</option>			  
                          <option value="6248">XEON GOLD 6248</option>      
                          <option value="6148">XEON GOLD 6148</option>    
                          <option value="6238">XEON GOLD 6238</option>                         
                          <option value="5120">XEON GOLD 5120</option>                                                                                <option value="4216">XEON SILVER 4216</option>                                                                              <option value="4110">XEON SILVER 4110</option>   
                          <option value="E5-2683">XEON E5-2683</option>       
                          <option value="E5-2650">XEON E5-2650</option>                                                                                                                                 
                          </select>                              
                        </div>            
                    </div>
                </div>
            </div>

            <div class="col-sm-2">
               <div class="form-group">
                  <div class="input-group">
                     <div class="input">
                        <label for="arch" class="form-label">AVX capability</label>
                        <select class="form-select mb-1 form-select-sm" style="background-color: #b7b796;" name = "arch" placeholder="avx2 .."/>
                        <option value="">All</option>
                        <option value="avx2">AVX-2</option>
                        <option value="avx512">AVX-512</option>       
                        </select>                     
                     </div>            
                  </div>
               </div>
            </div>

            <div class="col-sm-3">
                <div class="form-group">
                    <div class="input-group">
                        <div class="input">
                            <label for="dataset" class="form-label">Simulation system</label>
                            <select class="form-select mb-1 form-select-sm" style="background-color: #b7b796;" name = "dataset" placeholder="6n4o .."/>
                            <option value="6n4o">Argonaute (6n40): 239,131 atoms</option>
                            <option value="9naw">Parvovirus (9naw): 3,023,780 atoms</option>                           
                            <option value="4cg1">Cutinase (4cg1): 32,915 MM / 53 QM atoms</option>                        
                            </select>
                        </div>            
                    </div>
                </div>
            </div>
            <div class="col-sm-2"></div> 

            <div class="row my-4">
                <div class="d-flex justify-content-center">
                    <button class="btn btn-sm btn-outline-light mx-2" type="submit"><i class="fa fa-search"> Search</i></button>
                    <button class="btn btn-sm btn-outline-light px-2" type=button onClick="javascript:history.go(-1);"> <i class="fa fa-chevron-left px-1"></i></button>                      
                    {{ csv_file }}
                </div>
            </div>     
            <div class="row mt-4">
              <div class="d-flex justify-content-center align-items-center">
                <div style="color: #85b737;">APPLIED FILTERS: {{ querystr }}</div>
                <button class="btn btn-sm btn-outline-light px-2 mx-4" type="button"
                        onclick="location.href='{% url 'export' %}'">
                  <i class="fa fa-download me-2"></i> Save results
                </button>
              </div>
            </div>             
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock content%}

{% block content2%}
<div class="row gx-0" style="background-color: #eee;">
  <div class="col-sm-4">
    <div class="d-flex justify-content-center pt-3">
      <div class="card border-0" style="background-color: #eee;">
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item" style="background-color: #eee;">
              <h4 class="card-title">EXPLORING THE DATABASE</h4>
              <h5 class="card-subtitle p-2">Default view</h5>When this page is viewed no filters are initially applied. All benchmarks are selected and sorted by simulation speed. The chart on the right displays only top 30 benchmarks for clarity.</li>
            <li class="list-group-item" style="background-color: #eee;">
              <h5 class="card-subtitle p-2">Selecting benchmarks</h5>A subset of benchmarks can be selected using a custom chain of filters. Selected database entries can be downloaded as CSV files for further analysis or viewed in the <i>Benchmark Details</i> table at the bottom of the page.</li>
            <li class="list-group-item" style="background-color: #eee;">
              <h5 class="card-subtitle p-2">Detailed views</h5>A detailed view of each database entry can be accessed from <i>Benchmark ID</i> and <i>Software ID</i> search forms. Detailed views include submission commands and simulation input files. View example: PMEMD @Narval (benchmark ID=46)<a href={% url 'idbenchmark' %}?q=46><i class="fas fa-link link-success"></i></a>. </li>   
            <li class="list-group-item" style="background-color: #eee;">
              <h5 class="card-subtitle p-2">Parallel efficiency</h5><i>Efficiency</i> is computed as <i>PS/(SS * N)</i> where <i>PS</i> is speed of the parallel program, <i>SS</i> is speed of the serial program, and <i>N</i> is the number of CPUs or GPUs.</li> 
            <li class="list-group-item" style="background-color: #eee;">
              <h5 class="card-subtitle p-2">Viewing parallel speedup and efficiency</h5>              
              To view the graph of the dependence of parallel speedup and efficiency on the number of CPU/GPU equivalents select only one software and one cluster. View example: GROMACS @Narval <a href={% url 'bootstrapfilter' %}?software_contains=GROMACS.mpi&site_contains=Narval&dataset=6n4o><i class="fas fa-link link-success"></i></a>.</p></li> 
            <li class="list-group-item" style="background-color: #eee;">  
              <h5 class="card-subtitle p-2">Viewing QM/MM benchmarks</h5>To view QM/MM benchmarks select simulation system 4cg1 <a  href={% url 'bootstrapfilter' %}?software_contains=&software_id=&module_contains=&module_version=&site_contains=&gpu_model=&cpu_model=&arch=&dataset=4cg1 ><i class="fas fa-link link-success"></i></a>.</li>  
          </ul>                           
        </div>   
      </div>
    </div>
  </div>
  
  <div class="col-sm-8">
    <div class="d-flex justify-content-center pt-3">
      <div class="card border-0" style="background-color: #eee;" >
        <div class="card-body">
          <h3 class="card-title">Performance Chart For Selected Benchmarks</h3>
            <div class="card-img-top">
              {% autoescape off %} {{ plot_div }} {% endautoescape %}
              <div class="text-end" style="color: #666;"><small><sup>*</sup>Data updated {{date_updated | date}} </small> </div>
            </div>
        </div>
      </div>
    </div>  
  </div>
</div>

{% if not 'NO CPU BENCHMARKS' in plot_div_cost_cpu %}
<div class="row gx-0" style="background-color: #fff">

  <div class="col-sm-8">
    <div style="background-color: #fff">
        <div class="d-flex justify-content-center pt-3">
            <div class="card border-0" style="background-color: #fff" >
              <div class="card-body">
                <h3 class="card-title" style="color: #B79754;">Cost Of CPU-only Simulations</h3>
                  <div class="card-img-top">
                    {% autoescape off %}
                    {{ plot_div_cost_cpu }}
                    {% endautoescape %}
                    <div class="text-end" style="color: #666;"><small><sup>*</sup>Data updated {{date_updated | date}} </small> </div>
                  </div>
              </div>
            </div>
        </div>
    </div>
  </div>

  <div class="col-sm-4">
      <div class="container-fluid pt-3">
        <div class="row justify-content-center">
           <div class="col-auto" >
            <div class="card border-0" style="background-color: #fff;">
              <div class="card-body">
                <ul class="list-group list-group-flush">
                  <h4 class="card-title" style="color: #B79754;" >OPTIMIZING CPU USAGE</h4>
                  <li class="list-group-item">
                    <h5 class="card-subtitle p-2" style="color: #B79754;">Submitting CPU-only simulation</h5>CPU-only simulations reach performance comparable to GPU-accelerated ones only with hundreds of CPU cores. It is not uncommon for such jobs to wait in the queue for up to several days for such a significant resource to be available, especialy if a long time is requested.</li> 
                  <li class="list-group-item" style="background-color: #fff;">
                    <h5 class="card-subtitle p-2" style="color: #B79754;">Benchmarking CPU-only MD Engines</h5>We calculate CPU usage in core equivalents per year. Core equivalent is a bundle made up of a single core, and some memory associated with it <a href="https://docs.computecanada.ca/wiki/Allocations_and_compute_scheduling#What_is_a_core_equivalent_and_how_is_it_used_by_the_scheduler.3F"><i class="fas fa-external-link-alt link-success"></i></a>. For most of the systems one core equivalent includes 4000M per core.</li>  
                </ul>
               </div>                  
            </div>
          </div>
        </div>
      </div>
   </div>
</div>
{% endif %}

{% if not 'NO GPU BENCHMARKS' in plot_div_cost_gpu %}
<div class="row gx-0" style="background-color: #eee">
  <div class="col-sm-8"> 
     <div style="background-color: #eee">
        <div class="d-flex justify-content-center pt-3">
           <div class="card border-0" style="background-color: #eee;" >
              <div class="card-body">
                <h3 class="card-title" style="color: #B79754;">Cost Of GPU-accelerated Simulations</h3>
                   <div class="card-img-top">
                    {% autoescape off %} {{ plot_div_cost_gpu }} {% endautoescape %}
                    <div class="text-end" style="color: #666;"><small><sup>*</sup>Data updated {{date_updated | date}} </small> </div>             
                   </div>
              </div>
           </div>
        </div>
     </div>
  </div>

<div class="col-sm-4">
  <div>
    <div class="container-fluid pt-3">
      <div class="row justify-content-center">
         <div class="col-auto" >
          <div class="card border-0" style="background-color: #eee;">
            <div class="card-body">
                 <ul class="list-group list-group-flush">
                  <li class="list-group-item" style="background-color: #eee;">
                    <h4 class="card-title" style="color: #B79754;" >OPTIMIZING GPU USAGE</h4>
                    <h5 class="card-subtitle p-2" style="color: #B79754;">Parallel scaling to multiple GPUs</h5>Parallel scaling to multiple GPUs strongly depends on the compibation of software, hardware and simulation parameters. Often simulations do not run faster on multiple GPUs (PMEMD @Cedar example<a href={% url 'bootstrapfilter' %}?software_contains=PMEMD.cuda.MPI&site_contains=Cedar&gpu_model=P100-PCIE&dataset=6n4o><i class="fas fa-link link-success"></i></a>). Simulations on nodes with direct interconnect between GPUs (NVLink) are more likely to benefit from multiple GPUs, but efficiency decreases and cost goes up with the number of GPUs (NAMD3 @Cedar example <a href={% url 'bootstrapfilter' %}?software_contains=NAMD3.cuda&site_contains=Cedar&gpu_model=V100-SXM2&dataset=6n4o> <i class="fas fa-link link-success"></i></a>).</li>
                  <li class="list-group-item" style="background-color: #eee;">
                    <h5 class="card-subtitle p-2" style="color: #B79754;">Benchmarking GPU accelerated MD Engines</h5>For benchmarking we use the optimal number of cores per GPU (the number needed for the fastest simulation time but not exceeding the maximum number of CPU cores per GPU in a GPU equivalent).</li>

                  </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endif %}
</div>

<div class="container-fluid pt-3">
  <div class="card pt-3" style="background-color: #eee;">
      <div class="card-body">
          <div class="card-title"><h3>BENCHMARK RESULTS</h3>
              <button class="btn btn-sm btn-outline-light"><a style="color: #aaa" href="{% url 'export' %}">Download CSV</a></button>
          </div>
          {{ csv_file }}
          <div style="background-color: #eee;">
              <table class="table table-hover"> {% include "mdbench/t_head.html" %}
              {% for benchmark in page_obj.object_list %}
                <tr>{% include "mdbench/t_data.html" %}</tr>   
              {% endfor %} 
              </table>
          </div>  
         <div class="text-end"  style="color: #666;"><small>Date Updated: {{date_updated}}</small><div>              
      </div>
  </div>
</div>

{% if page_obj.has_other_pages %}
  <ul class="pagination pagination-sm justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{qurlstr}}">&laquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}

    {% for i in page_obj.paginator.page_range %}
      {% if page_obj.number == i %}
        <li class="page-item active"> <a class="page-link" > {{ i }} </a></li>
      {% else %}
        <li><a class="page-link" href="?page={{ i }}&{{qurlstr}}">{{ i }}</a></li>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&{{qurlstr}}">&raquo;</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
{% endif %}

{% endblock %}

